# ./安装 Vagrant 工具

请按照顺序, 依次安装如下软件:

- VirtualBox: https://download.virtualbox.org/virtualbox/5.1.38/VirtualBox-5.1.38-122592-Win.exe
- Vagrant: https://releases.hashicorp.com/vagrant/1.9.8/vagrant_1.9.8_i686.msi

> 安装完成后提示重启计算机, 则必须要重启



## 安装 Vagrant 插件

```shell
vagrant plugin install vagrant-vbguest
```

> 此插件必须安装, 否则将无法映射 window 目录到 linux 环境



## 初始化 Vagrant

新建一个 centos7 目录, 然后在 Powershell 中进入此目录, 执行:

```shell
vagrant init centos/7
```



## 配置 Vagrantfile 文件

初始化完成后, 可以在目录下看到一个 `Vagrantfile` 的文件, 使用编辑器打开, 并修改 (推荐 `EditPlus` 或 `Sublime Text`, 请一定不要使用Windows自带的记事本进行编辑)

```ruby
# 设置公共网络
config.vm.network "public_network", auto_config: false
config.vm.provision "shell",
  run: "always",
  inline: "ifconfig eth1 IP地址 netmask 子网掩码 up"
config.vm.provision "shell",
  run: "always",
  inline: "route add default gw 网关地址"

# 挂载开发目录
config.vm.synced_folder "E:/GoGame", "/GoGame", create: true, group: "root", owner: "root"
config.vm.synced_folder "E:/GoDev", "/GoDev", create: true, group: "root", owner: "root"

# 设置虚拟机的内存和CPU
config.vm.provider "virtualbox" do |v|
  v.memory = 4096
  v.cpus = 4
end
```

> 请注意配置中的 `IP地址` 、`网关地址`、`子网掩码`, 请参考你的电脑(Win7系统)的网卡信息进行配置
>
> 开发目录 `GoGame` 仅作为项目开发使用的 Golang 环境
>
> 开发目录 `GoDev` 作为个人代码测试使用的环境
>
> 挂载目录可以设置多个, 请不要直接使用 `/vagrant` 作为开发目录
>
> 如果你的电脑内存不够, 可设置 `v.memory` 的值为 `2048`, `v.cpus`设置值不建议小于4, 否则编译会很卡

配置完成后, 请使用如下命令重载配置:

```shell
vagrant reload --provision
```



## Vagrant 基本命令

```shell
# 启动
vagrant up

# 停止
vagrant halt

# 重启
vagrant reload

# 登录 Vagrant Shell
vagrant ssh
```

> 如果每次关闭电脑前, 没有使用 `halt` 命令停止虚拟机, 则下次启动时, 最好使用 `reload` 命令启动, 避免出错



# 服务器设置

## 关闭 SELINUX

编辑 `/etc/selinux/config` 文件, 修改 `SELINUX=enforcing` 为 `SELINUX=disabled`

保存退出后, 执行如下命令, 使其立即生效

```shell
setenforce 0
```



## 关闭防火墙

```shell
systemctl stop firewalld.service
systemctl disable firewalld.service
```



## 设置时区

```shell
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
```



## 安装基础工具

根据 centos7 系统不同的安装方式, 可能会缺少一些基本命令工具, 因此建议先执行下:

```shell
yum install -y wget nano zip unzip curl
```



# 配置开发环境

>本环境配置均在 `centos/7` 环境下进行

## Direnv v2.17.0

[direnv](https://github.com/direnv/direnv)是`shell`的环境切换器。它知道如何挂钩`bash`，`zsh`，`tcsh`，`fish`和`elvish`，以根据当前目录加载或卸载环境变量。这允许项目特定的环境变量而不会混淆`~/.profile`文件。

在每次提示之前，`direnv`检查当前目录和父目录中是否存在`.envrc`文件。如果该文件存在（并且已被`allow`），则将其加载到子`shell`中，然后所有导出的变量将被`direnv`捕获，然后提供给当前`shell`。

请执行如下命令安装 direnv: 

```shell
wget https://github.com/direnv/direnv/releases/download/v2.17.0/direnv.linux-amd64
mv direnv.linux-amd64 /usr/bin/direnv
chmod +x /usr/bin/direnv
echo 'eval "$(direnv hook bash)"' >> ~/.bashrc
source ~/.bashrc
```

在目标文件夹中，创建一个`.envrc`文件并在其中添加一些`export`指令。请注意，`.envrc`文件的内容必须是有效的`bash`语法，无论您使用的是何种`shell`。这是因为`direnv`总是用`bash`执行`.envrc`，这样`direnv`可以在`shell`中工作。如果尝试使用某些在`bash`中不起作用的语法（如`zsh`的嵌套扩展），会有问题。

编辑完`.envrc`会看到`direnv`警告`direnv: error .envrc is blocked.`。这是避免自动加载新文件的安全机制，需要手动执行`direnv allow`批准记载并看到`direnv`加载新环境。请注意，`direnv edit .`是一个快捷方式，可以在`$EDITOR`中打开文件，并在文件被修改自动`allow`该文件。

进入对应目录，环境自动加载，一旦你从目录中移出，它会自动卸载。如果回到它，它再次被加载。直接进入子目录也会加载。

简单测试下：

```
cd /path/to/project
echo "echo 'test direnv'" >> .envrc
direnv allow
```

那么再你再进入这个目录时，就会输出`test direnv`。



## Golang v1.10.4

```shell
wget https://dl.google.com/go/go1.10.4.linux-amd64.tar.gz
tar zxvf go1.10.4.linux-amd64.tar.gz
mv go /usr/local/go1.10.4
```



## Protobuf 3.6

```shell
wget https://github.com/google/protobuf/releases/download/v3.6.0/protoc-3.6.0-linux-x86_64.zip
unzip protoc-3.6.0-linux-x86_64.zip -d protoc
mv protoc /usr/local/protoc
echo 'export PATH=/usr/local/protoc/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
```



## Node.js v8.12.0 LTS

> 请注意, 我们只是借用Nodejs的部分工具, 所以请不要追求最新版本, 而应该使用 LTS 版本

```shell
wget https://nodejs.org/dist/v8.12.0/node-v8.12.0-linux-x64.tar.xz
tar xvf node-v8.12.0-linux-x64.tar.xz
mv node-v8.12.0-linux-x64 /usr/local/node
echo 'export PATH=/usr/local/node/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
```



# 安装运行环境

## 安装 consul

```shell
wget https://releases.hashicorp.com/consul/1.2.3/consul_1.2.3_linux_amd64.zip
unzip consul_1.2.3_linux_amd64.zip
mkdir -p /usr/local/consul/{bin,data}
mv consul /usr/local/consul/bin/
echo 'export PATH=/usr/local/consul/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
```

创建 `consul` 服务文件

```shell
touch /lib/systemd/system/consul.service
```

并写入如下内容

```
[Unit]
Description=consul agent
Requires=network-online.target
After=network-online.target

[Service]
Restart=on-failure
ExecStart=/usr/local/consul/bin/consul agent -dev -ui -data-dir=/usr/local/consul/data -advertise=127.0.0.1
ExecReload=/bin/kill -HUP $MAINPID
KillSignal=SIGTERM

[Install]
WantedBy=multi-user.target
```

启动服务

```shell
systemctl start consul
systemctl enable consul
```



## 安装 nsq

```shell
wget https://github.com/nsqio/nsq/releases/download/v1.1.0/nsq-1.1.0.linux-amd64.go1.10.3.tar.gz
tar zxvf nsq-1.1.0.linux-amd64.go1.10.3.tar.gz
mv nsq-1.1.0.linux-amd64.go1.10.3 /usr/local/nsq
echo 'export PATH=/usr/local/nsq/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
mkdir /usr/local/nsq/{config,data,log}
wget https://raw.githubusercontent.com/nsqio/nsq/master/contrib/nsqadmin.cfg.example
wget https://raw.githubusercontent.com/nsqio/nsq/master/contrib/nsqd.cfg.example
wget https://raw.githubusercontent.com/nsqio/nsq/master/contrib/nsqlookupd.cfg.example
mv *.cfg.example /usr/local/nsq/config/
cd /usr/local/nsq/config/
mv nsqadmin.cfg.example nsqadmin.cfg
mv nsqd.cfg.example nsqd.cfg
mv nsqlookupd.cfg.example nsqlookupd.cfg
```

编辑 `nsqadmin.cfg`文件, 注释掉文件末尾 `nsqd_http_addresses` 配置项

创建nsq的启动文件

```shell
touch /usr/lib/systemd/system/nsqd.service
touch /usr/lib/systemd/system/nsqlookupd.service
touch /usr/lib/systemd/system/nsqadmin.service
```

并写入如下内容

### nsqd.service 

```
[Unit]
Description=NSQD
After=network.target

[Service]
LimitCORE=infinity
LimitNOFILE=100000
LimitNPROC=100000
WorkingDirectory=/usr/local/nsq
ExecStart=/usr/local/nsq/bin/nsqd -config=/usr/local/nsq/config/nsqd.cfg
ExecReload=/bin/kill -HUP $MAINPID
Type=simple
KillMode=process
Restart=on-failure
RestartSec=10s
User=root

[Install]
WantedBy=multi-user.target
```

### nsqlookupd.service

```
[Unit]
Description=NSQLookupD
After=network.target

[Service]
LimitCORE=infinity
LimitNOFILE=100000
LimitNPROC=100000
WorkingDirectory=/usr/local/nsq
ExecStart=/usr/local/nsq/bin/nsqlookupd -config=/usr/local/nsq/config/nsqlookupd.cfg
ExecReload=/bin/kill -HUP $MAINPID
Type=simple
KillMode=process
Restart=on-failure
RestartSec=10s
User=root

[Install]
WantedBy=multi-user.target
```

### nsqadmin.service

```
[Unit]
Description=NSQAdmin
After=network.target

[Service]
LimitCORE=infinity
LimitNOFILE=100000
LimitNPROC=100000
WorkingDirectory=/usr/local/nsq
ExecStart=/usr/local/nsq/bin/nsqadmin -config=/usr/local/nsq/config/nsqadmin.cfg
ExecReload=/bin/kill -HUP $MAINPID
Type=simple
KillMode=process
Restart=on-failure
RestartSec=10s
User=root

[Install]
WantedBy=multi-user.target
```

启动 nsq 服务

```
systemctl start nsqd
systemctl start nsqlookupd
systemctl start nsqadmin
systemctl enable nsqd
systemctl enable nsqlookupd
systemctl enable nsqadmin
```



## 安装 redis

设置 redis 源

```shell
yum install epel-release
```

安装 redis

```shell
yum update
yum install -y redis
```

启动服务

```shell
systemctl start redis
systemctl enable redis
```



## 安装 mongodb

设置 MongoDB 的RPM源

```
touch /etc/yum.repos.d/mongodb-org-4.0.repo
```

写入如下内容:

```shell
[mongodb-org-4.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc
```

安装 MongoDB 4

```shell
yum update
yum install -y mongodb-org
```

启动服务

```shell
systemctl start mongod
systemctl enable mongod
```



## 安装 PM2 工具

```shell
npm install pm2 -g
```



# 项目初始化

请在Windows上`E:/GoGame`目录上点击鼠标右键, 使用[TortoiseSVN](https://tortoisesvn.net/index.zh.html)检出本项目的GO环境配置

```shell
svn co http://192.168.20.45/svn/server/golang
```

然后进入 centos7 环境下的 `/GoGame` 目录下

编辑该目录下的 `.envrc` 文件, 修改 `GOROOT` 为 `golang` 的安装目录

```shell
export GOROOT=/usr/local/go1.10.4
```

保存文件后执行: 

```shell
direnv allow
```

> 该配置下的工具是在 MacOS 下编译生成的, 在centos/7需要重新编译:
>
> ```shell
> # dep Golang依赖管理工具
> go get github.com/golang/dep/cmd/dep
> 
> # go-micro 开发工具
> go get github.com/golang/protobuf/{proto,protoc-gen-go}
> go get github.com/micro/protoc-gen-micro
> 
> # web 打包工具
> go get github.com/jteeuwen/go-bindata/...
> ```

然后进入 `src` 目录下, 检出项目代码

```shell
svn co http://192.168.20.45/svn/server/micro-service
```



## 编译管理工具

> 现在项目中已有WebUI的资源文件, 不需要再次编译. 如果要进行WebUI开发, 则需要执行下列操作

进入 `micro-service/web/ui` 目录下, 执行:

```shell
npm install
```

> 如果 npm install 安装失败, 那么请先执行 `npm install -g yarn` 再执行 `yarn` 进行 `ui `项目的依赖安装

再进入 `micro-service/web` 目录下, 执行:

```shell
./build_ui.sh && ./build_assets.sh
```



# 项目运行

进入 `micro-service` 目录下, 编辑 `ecosystem.config.js` 文件,  修改

```js
const GAME_GATEWAY_HOST = "你的IP地址";
```

修改

```js
{
  name      : 'gateway',
  script    : 'gateway',
  cwd       : LAUNCH_DIR + "bin/",    // 此项修改为 `LAUNCH_DIR + "bin/linux/"
  env       : GAME_ENV,
  watch     : IS_WATCH_FILE,
  args      : `--gateway_host=${GAME_GATEWAY_HOST} --gateway_port=${GAME_GATEWAY_PORT}`
},
```

修改完成后保存, 并执行如下命令启动Web:

```
pm2 start ecosystem.config.js --only web
```

> 如果启动时, 提示 `go` 命令不存在
>
> 则需要修改配置中所有 `script: "go" ` 为 `script: "/usr/local/go1.10.4/bin/go"`
>
> 然后执行 `pm2 delete all` 删除所有服务, 再重启服务

等待web服务启动完成后, 在window上使用浏览器打开:

```shell
http://你的虚拟主机IP地址:4561
```

输入初始账号 `admin` 密码 `123456`, 进入后, 在 `游戏` - `服务器管理` 下新增一个游戏服务器

最后启动所有服务:

```shell
pm2 start ecosystem.config.js
```

